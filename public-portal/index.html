<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal - Agile AI University</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:40px; color:#222; }
    h1 { font-size:40px; margin:0 0 20px; }
    .btn { display:inline-block; background:#2f80ed; color:white; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; text-decoration:none; }
    .btn.gray { background:#6b7280; }
    nav { margin-top:20px; display:flex; gap:12px; flex-wrap:wrap; }
    .note { color:#777; margin-top:22px; font-size:14px;}
  </style>
</head>
<body>

  <h1>Welcome to Agile AI University Portal</h1>

  <div id="signedOutUI">
    <p id="statusText">Not signed in</p>
    <button id="btnSignIn" class="btn">Sign in with Google</button>
  </div>

  <div id="signedInUI" style="display:none;">
    <p><strong id="userName"></strong></p>
    <p id="userEmail" style="color:#555;"></p>
    <button id="btnSignOut" class="btn gray">Sign out</button>

    <nav>
      <a href="/assessment.html" class="btn" style="background:#10b981">AI + Agile Assessment</a>
      <a href="#" class="btn" style="background:#8b5cf6">My Certificates (coming soon)</a>
      <a href="#" class="btn" style="background:#f59e0b">Alumni (coming soon)</a>
    </nav>

    <p class="note">You are signed in to the Agile AI University Portal.</p>
  </div>

  <!-- Firebase scripts (app, auth, firestore) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCti7ubJjnU8LJTghNaXhaSZzqCpozkeXg",
      authDomain: "fb-agileai-university.firebaseapp.com",
      projectId: "fb-agileai-university",
      storageBucket: "fb-agileai-university.appspot.com",
      messagingSenderId: "458881040066",
      appId: "1:458881040066:web:c832c420f9b4282e76c55b",
      measurementId: "G-1RMK7HMMLY"
    };

    firebase.initializeApp(firebaseConfig);
    // global auth and (optional) db references â€” used by portal
    const auth = firebase.auth();
    // DO NOT create a global db variable here if you don't want it; we create dbRef in widget safely.
    // const db = firebase.firestore(); // optional global if you want

    const provider = new firebase.auth.GoogleAuthProvider();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("signedOutUI").style.display = "none";
        document.getElementById("signedInUI").style.display = "block";
        document.getElementById("userName").textContent = user.displayName || user.email;
        document.getElementById("userEmail").textContent = user.email || '';
      } else {
        document.getElementById("signedOutUI").style.display = "block";
        document.getElementById("signedInUI").style.display = "none";
      }
    });

    document.getElementById("btnSignIn").onclick = () =>
      auth.signInWithPopup(provider);

    document.getElementById("btnSignOut").onclick = () =>
      auth.signOut();
  </script>

<!-- ============ Chat Widget Enhancements - start ============ -->
<style>
  /* Widget container (minimized floating button + modal) */
  #chatWidgetFloating {
    position: fixed;
    right: 22px;
    bottom: 22px;
    z-index: 9999;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  #chatWidgetBtn {
    width:64px; height:64px; border-radius:50%;
    background: linear-gradient(135deg,#2f80ed,#4f46e5);
    border: none; box-shadow: 0 8px 20px rgba(15,23,42,.18);
    display:flex; align-items:center; justify-content:center; color:#fff;
    cursor:pointer; outline: none; font-size:22px;
  }
  #chatBadge {
    position:absolute; right:-6px; top:-6px;
    background:#ef4444; color:#fff; font-size:12px; padding:3px 6px; border-radius:12px;
    box-shadow: 0 3px 8px rgba(0,0,0,.15);
  }

  /* Modal */
  #chatModal {
    position: fixed;
    right: 22px;
    bottom: 100px;
    width: 360px;
    max-width: calc(100% - 48px);
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 18px 50px rgba(2,6,23,.35);
    overflow: hidden;
    display: none;
    z-index: 10000;
  }

  /* header */
  #chatHeader { padding:12px 14px; display:flex; gap:10px; align-items:center; background:#f8fafc; border-bottom:1px solid #eef2f7; }
  #chatHeader img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
  #chatHeader .title { font-weight:700; color:#111827; font-size:15px; }
  #chatHeader .sub { font-size:12px; color:#6b7280; margin-top:2px; }

  /* messages */
  #chatBody { max-height: 380px; overflow:auto; padding:12px; background: linear-gradient(180deg,#ffffff,#fbfdff); }
  .cw-msg { margin:10px 0; display:flex; }
  .cw-msg.bot { align-items:flex-start; }
  .cw-bubble { padding:10px 12px; border-radius:12px; max-width:78%; line-height:1.35; font-size:14px; }
  .cw-bubble.bot { background:#f3f4f6; color:#111827; }
  .cw-bubble.user { background:#2f80ed; color:#fff; margin-left:auto; }

  /* typing dot animation */
  .typing {
    display:inline-block; padding:8px 10px; border-radius:10px; background:#e6eefb;
  }
  .typing-dot { display:inline-block; width:7px; height:7px; margin:0 3px; background:#4f46e5; border-radius:50%; opacity:0.4; animation: blink 1s infinite; }
  .typing-dot:nth-child(2){ animation-delay: 0.12s; }
  .typing-dot:nth-child(3){ animation-delay: 0.24s; }
  @keyframes blink { 0% { transform: translateY(0); opacity:.35 } 50% { transform: translateY(-5px); opacity:1 } 100% { transform: translateY(0); opacity:.35 } }

  /* greeting bubble */
  .greeting { background:#eef2ff; color:#1e293b; padding:8px 10px; border-radius:14px; display:inline-block; margin-bottom:8px; }

  /* input area */
  #chatFooter { padding:10px; border-top:1px solid #eef2f7; display:flex; gap:8px; background:#fff; }
  #chatInput { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6eef5; outline:none; font-size:14px; }
  #chatSend { background:#111827; color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; }

  /* small greeter badge */
  .greeter {
    position: absolute;
    right: 70px;
    bottom: 30px;
    z-index: 9998;
    display:none;
  }
  .greeter .bubble { background:#eef2ff; padding:8px 12px; border-radius:20px; color:#0f172a; box-shadow: 0 6px 18px rgba(2,6,23,.08); }
</style>

<div id="chatWidgetFloating" aria-hidden="false">
  <div class="greeter" id="greeterBubble"><div class="bubble">Hi â€” need help with the portal?</div></div>

  <div id="chatModal" role="dialog" aria-label="Help chat">
    <div id="chatHeader">
      <img src="https://assets.agileai.university/logo-192.png" alt="logo" onerror="this.style.display='none'"/>
      <div>
        <div class="title">Agile AI University</div>
        <div class="sub">Help Bot â€” answers from official FAQs</div>
      </div>
    </div>
    <div id="chatBody">
      <!-- initial greeting will be inserted by JS -->
    </div>
    <div id="chatFooter">
      <input id="chatInput" placeholder="Ask a question..." />
      <button id="chatSend">Ask</button>
    </div>
  </div>

  <button id="chatWidgetBtn" aria-label="Open chat">
    ðŸ’¬
    <div id="chatBadge" style="display:none">!</div>
  </button>
</div>

<script>
  // ---------- config ----------
  const WIDGET_AUTO_OPEN_MS = 5000; // 5s auto open
  const GREETING_SHOW_MS = 6000;    // show greeting bubble for 6s

  // ---- SAFETY: don't redeclare global db/auth if they exist ----
  // use dbRef and authRef within widget to avoid "Cannot redeclare" errors
  const dbRef = (typeof db !== 'undefined') ? db : (firebase.firestore ? firebase.firestore() : null);
  const authRef = (typeof auth !== 'undefined') ? auth : (firebase.auth ? firebase.auth() : null);

  // Elements
  const chatBtn = document.getElementById('chatWidgetBtn');
  const modal = document.getElementById('chatModal');
  const body = document.getElementById('chatBody');
  const input = document.getElementById('chatInput');
  const send = document.getElementById('chatSend');
  const greeter = document.getElementById('greeterBubble');
  const badge = document.getElementById('chatBadge');

  // local data
  let faqs = []; // loaded from firestore
  let widgetOpen = false;

  // helper: append bot message
  function appendBot(htmlContent) {
    const wrap = document.createElement('div');
    wrap.className = 'cw-msg bot';
    const bubble = document.createElement('div');
    bubble.className = 'cw-bubble bot';
    bubble.innerHTML = htmlContent;
    wrap.appendChild(bubble);
    body.appendChild(wrap);
    body.scrollTop = body.scrollHeight;
  }
  function appendUser(text) {
    const wrap = document.createElement('div');
    wrap.className = 'cw-msg user';
    const bubble = document.createElement('div');
    bubble.className = 'cw-bubble user';
    bubble.textContent = text;
    wrap.appendChild(bubble);
    body.appendChild(wrap);
    body.scrollTop = body.scrollHeight;
  }

  // typing indicator
  function showTyping() {
    const el = document.createElement('div');
    el.className = 'cw-msg bot typing-wrapper';
    el.dataset.typing = '1';
    const b = document.createElement('div');
    b.className = 'typing';
    b.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
    el.appendChild(b);
    body.appendChild(el);
    body.scrollTop = body.scrollHeight;
    return el;
  }
  function removeTyping(el) { if (el && el.parentNode) el.parentNode.removeChild(el); }

  // load faqs once
  async function loadFaqs() {
    if (!dbRef) return;
    try {
      const snap = await dbRef.collection('faqs').get();
      faqs = snap.docs.map(d => ({ id: d.id, ...(d.data()) }));
      console.log('widget: loaded faqs', faqs.length);
    } catch (e) {
      console.warn('widget: failed to load faqs', e);
    }
  }

  // simple match (same logic as your bot page)
  function findMatch(q) {
    const qLower = q.toLowerCase().trim();
    if (!qLower) return null;
    const words = qLower.split(/\W+/).filter(Boolean);
    let best = null, bestScore = 0;
    for (const f of faqs) {
      const text = ((f.question||'') + ' ' + (f.answer||'')).toLowerCase();
      let score = 0;
      for (const w of words) {
        if (w.length < 3) continue;
        if (text.includes(w)) score += 1;
      }
      if ((f.question||'').toLowerCase().includes(qLower)) score += 2;
      if (score > bestScore) { bestScore = score; best = f; }
    }
    return bestScore >= 1 ? best : null;
  }

  // analytics write (uses dbRef/authRef)
  async function recordQueryAnalytics(questionText, matchedFaq) {
    if (!dbRef) return;
    try {
      const user = authRef && authRef.currentUser ? authRef.currentUser : null;
      const payload = {
        question: questionText,
        matched: !!matchedFaq,
        matchedId: matchedFaq ? matchedFaq.id : null,
        matchedQuestion: matchedFaq ? matchedFaq.question : null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (user) { payload.uid = user.uid; payload.email = user.email; }
      await dbRef.collection('bot_queries').add(payload);
    } catch (e) {
      console.warn('widget: analytics error', e);
    }
  }

  // handle ask
  async function handleAsk() {
    const txt = input.value.trim();
    if (!txt) return;
    appendUser(txt);
    input.value = '';
    // typing
    const t = showTyping();
    // small delay to feel natural
    await new Promise(r => setTimeout(r, 650));
    // find match
    const match = findMatch(txt);
    removeTyping(t);
    if (match) {
      appendBot('<strong>'+escapeHtml(match.question)+'</strong><div style="margin-top:6px">'+escapeHtml(match.answer)+'</div>');
    } else {
      appendBot("I couldn't find a direct match in FAQs. Try simpler keywords or use the fallback form (link below).<br><a href='https://docs.google.com/forms/d/YOUR_FORM_ID/viewform' target='_blank'>Fallback form</a>");
    }
    // analytics
    recordQueryAnalytics(txt, match);
  }

  // escape helper
  function escapeHtml(s){ return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/\'/g,'&#39;'); }

  // open/close widget
  function openWidget() {
    if (widgetOpen) return;
    widgetOpen = true;
    modal.style.display = 'block';
    greeter.style.display = 'none';
    badge.style.display = 'none';
    // initial greetings
    appendBot('<div class="greeting">Hello â€” I can answer common questions. Ask me anything about Agile AI University.</div>');
    // focus input
    setTimeout(()=> input.focus(), 200);
  }
  function closeWidget() {
    if (!widgetOpen) return;
    widgetOpen = false;
    modal.style.display = 'none';
  }

  // wire UI
  chatBtn.addEventListener('click', ()=> {
    if (widgetOpen) closeWidget(); else openWidget();
  });
  send.addEventListener('click', handleAsk);
  input.addEventListener('keydown', (e)=> { if (e.key === 'Enter') handleAsk(); });

  // auto open after 5s if user hasn't opened
  setTimeout(()=> {
    greeter.style.display = 'block';
    // show greeter then auto open
    setTimeout(()=> {
      greeter.style.display = 'none';
      openWidget();
    }, GREETING_SHOW_MS);
  }, WIDGET_AUTO_OPEN_MS);

  // show notification badge if faqs not loaded state or messages exist
  // minimal badge logic: show until user opens widget
  badge.style.display = 'block';

  // initial load
  (async function initWidget(){
    await loadFaqs();
    // if faqs loaded, hide badge
    if (faqs.length) badge.style.display = 'none';
  })();

  // close widget when clicking outside
  document.addEventListener('click', function(e){
    if (!modal.contains(e.target) && !chatBtn.contains(e.target) && widgetOpen) {
      closeWidget();
    }
  });

</script>
<!-- ============ Chat Widget Enhancements - end ============ -->

</body>
</html>
